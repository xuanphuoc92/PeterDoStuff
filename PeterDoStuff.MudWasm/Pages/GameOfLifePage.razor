@page "/GameOfLife"
@inject GameOfLife Game

<PageTitle>Conway's Game of Life</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Conway's Game of Life</MudText>
<MudText Class="mb-8">This is playground for Conway's Game of Life. Limitted size: 30x30.</MudText>

@* Game control bar *@
<div class="d-flex justify-space-around flex-grow-1 gap-4 align-center">
    <MudButton Variant="Variant.Filled" OnClick="Clear" StartIcon="@Icons.Material.Filled.ClearAll">
        Clear
    </MudButton>
    @if (isStart == false)
    {
        <MudButton Variant="Variant.Filled" OnClick="Start" StartIcon="@Icons.Material.Filled.PlayArrow">
            Start
        </MudButton>
    }
    else
    {
        <MudButton Variant="Variant.Filled" OnClick="Stop" StartIcon="@Icons.Material.Filled.Stop">
            Stop
        </MudButton>
    }
    <MudButton Variant="Variant.Filled" OnClick="Next" StartIcon="@Icons.Material.Filled.SkipNext">
        Next
    </MudButton>
</div>

<MudDivider DividerType="DividerType.Middle" Class="my-6" />

@* Game grid *@
@for (int x = 1; x <= Game.Width; x++)
{
    <div class="d-flex justify-md-center">
    @for (int y = 1; y <= Game.Height; y++)
    {
        var cell = Game.GetCell(x, y);
        <MudPaper Height="25px" Width="25px"
            Class="d-flex justify-center align-center"
            Style=@($"background-color:{GetColor(cell)}")
            @onclick="() => Flip(cell)"/>
    }
    </div>
}

@code {
    private bool isStart = false;
    private Timer Timer;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        Clear();
        Timer = new Timer(Tick, null, 0, 500);
    }

    private void Tick(object? _ = null)
    {
        if (isStart == false) return;
        Next();
        InvokeAsync(StateHasChanged);
    }

    private void Clear()
    {
        Game = new GameOfLife(30, 30);
        isStart = false;
    }

    private void Start()
    {
        isStart = true;
    }

    private void Stop()
    {
        isStart = false;
    }

    private void Next()
    {
        Game.Next();
    }

    private string GetColor(GameOfLife.Cell cell)
    {
        return cell.State == GameOfLife.CellState.Live
            ? Colors.Teal.Lighten1
            : "none";
    }

    private void Flip(GameOfLife.Cell cell)
    {
        if (cell.State == GameOfLife.CellState.Live)
            cell.State = GameOfLife.CellState.Dead;
        else
            cell.State = GameOfLife.CellState.Live;
    }
}
